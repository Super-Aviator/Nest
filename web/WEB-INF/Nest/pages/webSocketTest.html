<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>LayIM测试</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
    <script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="../reconnecting-websocket/reconnecting-websocket.min.js"></script>
</head>

<body class="layui-bg-black">
    <script src="../layui/layui.js"></script>
    <script>
        var socket;
        var id=2;

        layui.use('layim', function (layim) {
            //基础配置
            layim.config({

                //获取主面板列表信息，下文会做进一步介绍
                init: {
                    url: 'http://localhost:8080/user/get-info' //接口地址（返回的数据格式见下文）
                    , type: 'get' //默认get，一般可不填
                    , data: {
                        "id": id
                    } //额外参数
                }
                , initSkin: '6.jpg'//设置初始皮肤
                , skin: [
                    '../layui/css/modules/layim/skin/6.jpg',
                    '../layui/css/modules/layim/skin/7.jpg'
                ]
                , brief: false//是否始终开启面板
                , isAudio: true//是否开启语音
                , right: "150px"//面板右偏移量

                //获取群员接口（返回的数据格式见下文）
                , members: {
                    url: 'http://localhost:8080/group/get-members' //接口地址（返回的数据格式见下文）
                    , type: 'get' //默认get，一般可不填
                    , data: {
                    } //额外参数
                },

                //隐藏面板时显示的内容
                title: "My Nest"

                //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
                , uploadImage: {
                    url: 'http://localhost/image' //接口地址
                    , type: 'post' //默认post
                }

                //上传文件接口（返回的数据格式见下文），若不开启文件上传，剔除该项即可
                , uploadFile: {
                    url: '' //接口地址
                    , type: 'post' //默认post
                }

                , msgbox: layui.cache.dir + 'css/modules/layim/html/msgbox.html' //消息盒子页面地址，若不开启，剔除该项即可
                , find: layui.cache.dir + 'css/modules/layim/html/find.html' //发现页面地址，若不开启，剔除该项即可
                , chatLog: layui.cache.dir + 'css/modules/layim/html/chatlog.html' //聊天记录页面地址，若不开启，剔除该项即可
            });

            //监听发送的消息
            layim.on('sendMessage', function (res) {
                var mine = res.mine; //包含我发送的消息及我的信息
                var to = res.to;

                var data = {
                    username: mine.username
                    , avatar: mine.avatar
                    , id: to.id
                    , type: to.type
                    , content: mine.content
                    , cid: to.id
                    , mine: mine.mine
                    , fromid: to.id
                };

                var msg = {
                    emit: "chat"
                    , data: data
                }
                socket.send(JSON.stringify(msg));
                alert(JSON.stringify(data));
            });

            //init方法调用结束时事件触发
            layim.on('ready', function (options) {
                // console.log(options);

                socket = new ReconnectingWebSocket("ws://localhost:8081/chat", null, { reconnectInterval: 3000 });//掉线重连机制
                socket.onerror = function () {
                    layer.msg('连接失败，重试中', { icon: 2, offset: 't', anim: 5 });
                };

                socket.onopen = function () {
                    layer.msg('连接成功', { icon: 1, offset: 't', anim: 1 });
                    socket.send(id+"");
                };

                socket.onmessage = function (evt) {
                    var d=evt.data;
                    layim.getMessage(d);
                    alert(JSON.stringify(evt)+"-----");
                    // if (evt.type === 'chat') {
                    //     // alert(evt.data);
                    //     layim.getMessage(JSON.parse(evt.data));
                    // } else if (evt.type === 'system') {
                    //     // alert(evt.data);
                    //     layim.getMessage(JSON.parse(evt.data));
                    // }
                }

                socket.onclose = function () {
                    socket.close();
                    layer.msg('主机关闭了链接或者账号已已在其他地方登录', { icon: 5, offset: 't', anim: 6 });
                };

            });

            //监听在线状态
            layim.on('online', function (status) {

                $.post('http://localhost:8080/user/change-status', {
                    id: 1
                    , status: status
                });

                //使用jsonp来进行跨域访问
                // $.ajax({
                //     url: "http://localhost:8080/user/change-status",
                //     type: "POST",
                //     data: {
                //         id: 1
                //         , status: sta
                //     },
                //     dataType: "jsonp", //指定服务器返回的数据类型
                // });

            });

            //监听签名修改
            layim.on('sign', function (value) {
                $.post('http://localhost:8080/user/change-sign', {
                    id: 1
                    , sign: value
                });
            });

        });

    </script>
</body>

</html>